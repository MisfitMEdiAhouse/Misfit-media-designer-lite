<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Misfit Designer — Upload & AI Prompt</title>
<style>
  :root{ --bg:#0b0b0b; --panel:#151515; --line:#2a2a2a; --accent:#E63946; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#eaeaea}
  .bar{display:flex;gap:10px;align-items:center;padding:12px;border-bottom:1px solid var(--line);background:var(--panel);position:sticky;top:0;z-index:5}
  .bar h1{font-size:16px;margin:0 12px 0 0;opacity:.8}
  .btn{background:#222;border:1px solid var(--line);color:#fff;padding:9px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .grow{flex:1}
  .prompt{display:flex;gap:8px;align-items:center}
  .prompt input{flex:1;background:#101010;border:1px solid var(--line);color:#fff;padding:10px 12px;border-radius:10px}
  .wrap{display:grid;grid-template-columns:1fr 320px;gap:14px;height:calc(100% - 58px);padding:12px}
  .stage{position:relative;background:radial-gradient(50% 50% at 50% 45%, #101010 0%, #0c0c0c 70%);border:1px dashed #2f2f2f;border-radius:14px;overflow:hidden}
  canvas{display:block;width:100%;height:100%}
  .side{background:#111;border:1px solid var(--line);border-radius:14px;padding:12px;overflow:auto}
  .hint{font-size:12px;opacity:.7;margin-top:8px}
  .drop-mask{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(230,57,70,.08);border:2px dashed var(--accent);color:#fff;font-weight:700}
  .handle{position:absolute;width:16px;height:16px;border:2px solid #fff;border-radius:50%;background:#0008}
  .handle.br{right:8px;bottom:8px;cursor:nwse-resize}
</style>
</head>
<body>
  <div class="bar">
    <h1>Misfit Designer</h1>
    <input id="file" type="file" accept="image/*" hidden>
    <button class="btn" id="pick">Upload Image</button>
    <div class="prompt grow">
      <input id="prompt" placeholder="Type art prompt (e.g., 'neon skull with rose, punk zine vibes')"/>
      <button class="btn primary" id="generate">Generate</button>
    </div>
    <button class="btn" id="exportPNG">Export PNG</button>
    <button class="btn" id="exportSVG">Export SVG</button>
  </div>

  <div class="wrap">
    <div class="stage" id="stage">
      <canvas id="canvas" width="1800" height="1200" aria-label="Design canvas"></canvas>
      <div class="drop-mask" id="dropMask">Drop image to place</div>
      <div class="handle br" id="handleBR" title="Resize"></div>
    </div>
    <div class="side">
      <b>How to use</b>
      <ul>
        <li>Click <i>Upload Image</i> or just <b>drag & drop</b> / <b>paste</b> (Ctrl/Cmd-V).</li>
        <li>Enter a prompt and hit <b>Generate</b> to use AI (OpenAI Images API).</li>
        <li>Drag image to move. Use the bottom-right dot to <b>resize</b>.</li>
        <li>Export PNG/SVG for print or decals.</li>
      </ul>
      <div class="hint">Tip: transparent PNGs work great for mockups.</div>
    </div>
  </div>

<script>
const fileInput = document.getElementById('file');
const pickBtn   = document.getElementById('pick');
const genBtn    = document.getElementById('generate');
const promptEl  = document.getElementById('prompt');
const stage     = document.getElementById('stage');
const mask      = document.getElementById('dropMask');
const canvas    = document.getElementById('canvas');
const ctx       = canvas.getContext('2d');
const hBR       = document.getElementById('handleBR');

let imgObj = null; // {img, x, y, w, h}
let dragging = false, resizing = false, dragDX=0, dragDY=0;

// ------- helpers
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.strokeStyle = '#1a1a1a';
  ctx.lineWidth = 1;
  for(let x=0;x<canvas.width;x+=100){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
  for(let y=0;y<canvas.height;y+=100){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
  ctx.restore();

  if(imgObj){
    ctx.drawImage(imgObj.img, imgObj.x, imgObj.y, imgObj.w, imgObj.h);
    const rect = stage.getBoundingClientRect();
    const scaleX = rect.width / canvas.width;
    const scaleY = rect.height / canvas.height;
    hBR.style.transform =
      `translate(${(imgObj.x+imgObj.w)*scaleX - 8}px, ${(imgObj.y+imgObj.h)*scaleY - 8}px)`;
  }
}

function placeImage(src){
  const im = new Image();
  im.onload = ()=>{
    const maxW = canvas.width * 0.6;
    const scale = Math.min(1, maxW / im.width);
    const w = im.width * scale, h = im.height * scale;
    imgObj = { img: im, x: (canvas.width - w)/2, y: (canvas.height - h)/2, w, h };
    hBR.style.display = 'block';
    draw();
  };
  im.src = src;
}

// ------- upload (picker)
pickBtn.onclick = ()=> fileInput.click();
fileInput.onchange = (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ev => placeImage(ev.target.result);
  r.readAsDataURL(f);
};

// ------- drag & drop
['dragenter','dragover'].forEach(ev=>stage.addEventListener(ev,(e)=>{e.preventDefault();mask.style.display='flex';}));
['dragleave','drop'].forEach(ev=>stage.addEventListener(ev,(e)=>{e.preventDefault(); if(ev==='drop') handleDrop(e); mask.style.display='none';}));
function handleDrop(e){
  const f = e.dataTransfer.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ev => placeImage(ev.target.result); r.readAsDataURL(f);
}

// ------- paste from clipboard
window.addEventListener('paste',(e)=>{
  if(!e.clipboardData) return;
  for(const item of e.clipboardData.items){
    if(item.type.indexOf('image')===0){
      const f = item.getAsFile();
      const r = new FileReader(); r.onload = ev => placeImage(ev.target.result); r.readAsDataURL(f);
      break;
    }
  }
});

// ------- move & resize
stage.addEventListener('mousedown',(e)=>{
  if(!imgObj) return;
  const rect = stage.getBoundingClientRect();
  const sx = (e.clientX - rect.left) * (canvas.width/rect.width);
  const sy = (e.clientY - rect.top)  * (canvas.height/rect.height);
  if(sx>imgObj.x && sx<imgObj.x+imgObj.w && sy>imgObj.y && sy<imgObj.y+imgObj.h){
    dragging = true; dragDX = sx - imgObj.x; dragDY = sy - imgObj.y;
  }
});
window.addEventListener('mousemove',(e)=>{
  if(!imgObj) return;
  const rect = stage.getBoundingClientRect();
  const sx = (e.clientX - rect.left) * (canvas.width/rect.width);
  const sy = (e.clientY - rect.top)  * (canvas.height/rect.height);
  if(dragging){ imgObj.x = sx - dragDX; imgObj.y = sy - dragDY; draw(); }
  if(resizing){
    imgObj.w = Math.max(40, sx - imgObj.x);
    imgObj.h = Math.max(40, sy - imgObj.y);
    draw();
  }
});
window.addEventListener('mouseup',()=>{ dragging=false; resizing=false; });
hBR.addEventListener('mousedown', (e)=>{ e.stopPropagation(); resizing=true; });

// ------- export
document.getElementById('exportPNG').onclick = ()=>{
  const a = document.createElement('a');
  a.href = canvas.toDataURL('image/png');
  a.download = 'misfit-design.png';
  a.click();
};
document.getElementById('exportSVG').onclick = ()=>{
  if(!imgObj){ alert('Place an image first.'); return; }
  const svg =
   `<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}">
      <image href="${canvas.toDataURL('image/png')}" x="0" y="0" width="${canvas.width}" height="${canvas.height}"/>
    </svg>`;
  const blob = new Blob([svg], {type:'image/svg+xml'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='misfit-design.svg'; a.click();
  URL.revokeObjectURL(url);
};

// ------- AI prompt (real API)
window.MISFIT_GENERATE = async function(prompt) {
  const r = await fetch('/api/generate-image', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ prompt })
  });
  const j = await r.json();
  if (!r.ok) throw new Error(j.error || 'Generation failed');
  return j.dataUrl;
};

genBtn.onclick = async ()=>{
  const prompt = promptEl.value.trim();
  if(!prompt){ alert('Type a prompt first.'); return; }
  genBtn.disabled = true; genBtn.textContent = 'Generating…';
  try{
    const src = await window.MISFIT_GENERATE(prompt);
    placeImage(src);
  }catch(err){ alert('Generation failed.'); console.error(err); }
  genBtn.disabled = false; genBtn.textContent = 'Generate';
};
</script>
</body>
</html>
